log:
  level: info
dns:
  servers:
    - tag: cloudflare
      address: tcp://1.1.1.1
      strategy: ipv4_only
    - tag: cloudflare_审计
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: 审计
    - tag: cloudflare_OpenAI
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: OpenAI
    - tag: cloudflare_Google
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: Google
    - tag: cloudflare_Tiktok
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: Tiktok
    - tag: local
      address: udp://223.5.5.5 #最好是dhcp://auto
      detour: direct
    - tag: system
      address: local
  rules:
    - outbound: any
      server: local
    - clash_mode: Direct
      server: local
    - clash_mode: Global
      server: cloudflare
    - domain_suffix:
        - .lan
        - .local
      server: system
    - rule_set: 审计
      server: cloudflare_审计
    - rule_set: geosite-openai
      server: cloudflare_OpenAI
    - rule_set: Google
      server: cloudflare_Google
    - rule_set: geosite-tiktok
      server: cloudflare_Tiktok
    - rule_set: geosite-geolocation-!cn
      server: cloudflare
    - rule_set: 
        - geosite-geolocation-cn
        - geoip-cn
      server: local
    - clash_mode: Default
      server: cloudflare
  independent_cache: true
  reverse_mapping: true #解决只靠嗅探udp嗅探不出域名而只用ip分流的问题
inbounds:
  - type: mixed
    tag: mixed-in
    listen: ::1
    listen_port: 1080
    sniff: true
  - type: tun
    tag: tun-in
    address:
      - 172.18.0.1/30
      - fdfe:dcba:9876::1/126
    auto_route: true
    strict_route: true
    platform:
      http_proxy:
        enabled: false #mixed域名入站不解析域名直接通过域名分流，导致geoip规则失效
        server: ::1
        server_port: 1080
    sniff: true
outbounds:
  - type: selector
    tag: select
    outbounds:
      - auto
    interrupt_exist_connections: true
  - type: urltest
    tag: auto
    outbounds: []
  - type: selector
    tag: 审计
    outbounds:
      - select
    interrupt_exist_connections: true
  - type: selector
    tag: OpenAI
    outbounds:
      - select
    interrupt_exist_connections: true
  - type: selector
    tag: Google
    outbounds:
      - select
    interrupt_exist_connections: true
  - type: selector
    tag: UDP
    outbounds:
      - select
    interrupt_exist_connections: true
  - type: selector
    tag: Tiktok
    outbounds:
      - select
    interrupt_exist_connections: true
  - type: direct
    tag: direct
  - type: block
    tag: block
  - type: dns
    tag: dns-out
route:
  rules:
    - clash_mode: Direct
      outbound: direct
    - clash_mode: Global
      outbound: select
    - type: logical
      mode: or
      rules:
        - protocol: dns
        - port: 53
      outbound: dns-out
    - ip_is_private: true
      outbound: direct
    - type: logical
      mode: and
      rules:
        - type: logical
          mode: or
          rules:
            - network: udp
              port: 
                - 443
                - 80
            - protocol: quic
        - type: logical #像是clientservices.googleapis.com既属于geosite-geolocation-!cn又属于geosite-geolocation-cn的处理
          mode: or
          rules:
            - rule_set:
                - geosite-geolocation-!cn
            - rule_set:
                - geoip-cn
                - geosite-geolocation-cn
              invert: true
      outbound: block
    - type: logical
      mode: and
      rules:
        - type: logical
          mode: or
          rules:
            - rule_set:
                - geosite-geolocation-!cn
            - rule_set:
                - geoip-cn
                - geosite-geolocation-cn
              invert: true
        - network: udp
      outbound: UDP
    - rule_set: 审计
      outbound: 审计
    - rule_set: geosite-openai
      domain:
        - cdn.auth0.com
      outbound: OpenAI
    - rule_set: Google
      outbound: Google
    - rule_set: geosite-tiktok
      outbound: Tiktok
    - rule_set:
        - geosite-geolocation-!cn
      outbound: select
    - rule_set:
        - geoip-cn
        - geosite-geolocation-cn
      outbound: direct
    - clash_mode: Default
      outbound: select
    - process_name: #用以启用在ui中显示进程
        - placeholder
      outbound: select
  rule_set:
    - type: remote
      tag: geosite-geolocation-cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-cn.srs
      download_detour: direct
    - type: remote
      tag: geosite-geolocation-!cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-!cn.srs
      download_detour: direct
    - type: remote
      tag: geoip-cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs
      download_detour: direct
    - type: remote
      tag: geosite-openai
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-openai.srs
      download_detour: direct
    - type: remote
      tag: geosite-google
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google.srs
      download_detour: direct
    - type: remote
      tag: geosite-google@cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google@cn.srs
      download_detour: direct
    - type: inline
      tag: 审计
      rules:
        - domain_regex:
            - (.*.||)(dafahao|minghui|dongtaiwang|epochtimes|ntdtv|falundafa|wujieliulan|voachinese).(org|com|net)
    - type: inline
      tag: Google
      rules:
        - domain:
            - www.google.com
            - google.com
    - type: remote
      tag: geosite-tiktok
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-tiktok.srs
      download_detour: direct
  auto_detect_interface: true
experimental:
  cache_file:
    enabled: true
    store_rdrc: true
  clash_api:
    external_controller: 127.0.0.1:9090
    external_ui: dashboard
    default_mode: Default
