log:
  level: info
dns:
  servers:
    - tag: cloudflare
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: select
    - tag: cloudflare_Global
      address: https://1.1.1.1/dns-query
      strategy: ipv4_only
      detour: select
    - tag: cloudflare_审计
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: 审计
    - tag: cloudflare_OpenAI
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: OpenAI
    - tag: cloudflare_Google
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: Google
    - tag: cloudflare_TikTok
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: TikTok
    - tag: cloudflare_YouTube
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: YouTube
    - tag: cloudflare_Wikipedia
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: Wikipedia
    - tag: cloudflare_巴哈姆特
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: 巴哈姆特
    - tag: cloudflare_Amazon
      address: tcp://1.1.1.1
      strategy: ipv4_only
      detour: Amazon
    - tag: local
      address: udp://223.5.5.5 #最好是dhcp://auto
      detour: direct
    - tag: system
      address: local
  rules:
    - outbound: any
      server: local
    - inbound: 审计checker-in
      server: cloudflare
    - inbound: 审计checker_无审计-in
      server: cloudflare_审计
    - clash_mode: Direct
      server: local
    - clash_mode: Global
      server: cloudflare_Global
    - domain_suffix:
        - .lan
        - .local
      server: system
    - rule_set: geosite-audit
      server: cloudflare_审计
    - rule_set: geosite-openai
      server: cloudflare_OpenAI
    - rule_set: Google
      server: cloudflare_Google
    - type: logical
      mode: or
      rules:
        - package_name: com.zhiliaoapp.musically
        - rule_set: geosite-tiktok
      server: cloudflare_TikTok
    - rule_set: geosite-youtube
      server: cloudflare_YouTube
    - rule_set: geosite-wikimedia
      server: cloudflare_Wikipedia
    - rule_set: geosite-bahamut
      server: cloudflare_巴哈姆特
    - type: logical
      mode: and
      rules:
        - rule_set: geosite-amazon
        - domain_suffix:
            - cloudfront.net
          invert: true
      server: cloudflare_Amazon
    - rule_set: geosite-geolocation-!cn
      server: cloudflare
    - rule_set:
        - geosite-geolocation-cn
        - geoip-cn
      server: local
    - clash_mode: Default
      server: cloudflare
  independent_cache: true
  reverse_mapping: true #解决只靠嗅探udp嗅探不出域名而只用ip分流的问题
inbounds:
  - type: mixed
    tag: mixed-in
    listen: 127.0.0.1
    listen_port: 1080
    sniff: true
  - type: tun
    tag: tun-in
    address:
      - 172.18.0.1/30
      #- fdfe:dcba:9876::1/126 #像是Facebook这种不使用DNS来解析域名的，会以为支持ipv6而硬上，但节点不支持导致连接被关闭
    auto_route: true
    strict_route: true
    platform:
      http_proxy:
        enabled: false #mixed域名入站不解析域名直接通过域名分流，导致geoip规则失效
        server: 127.0.0.1
        server_port: 1080
    sniff: true
    route_exclude_address: #为了让局域网主机还能访问本机0.0.0.0服务器
      - 192.168.0.0/16
      - fc00::/7
  - type: mixed
    tag: 审计checker-in
    listen: 127.0.0.1
    listen_port: 1081
    sniff: true
  - type: mixed
    tag: 审计checker_无审计-in
    listen: 127.0.0.1
    listen_port: 1082
    sniff: true
outbounds:
  - type: selector
    tag: select
    outbounds:
      - auto
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: urltest
    tag: auto
    outbounds: []
  - type: selector
    tag: Port22SSH
    outbounds:
      - direct
      - 审计
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: 审计
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: OpenAI
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: Google
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: UDP
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: TikTok
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: YouTube
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: Wikipedia
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: 巴哈姆特
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: selector
    tag: Amazon
    outbounds:
      - select
      - Hong Kong
      - Singapore
      - Taiwan
    interrupt_exist_connections: true
  - type: urltest
    tag: Hong Kong
    outbounds-regex: .*香港.*
  - type: urltest
    tag: Singapore
    outbounds-regex: .*新加坡.*
  - type: urltest
    tag: Taiwan
    outbounds-regex: .*台湾.*
  - type: direct
    tag: direct
  - type: block
    tag: block
  - type: dns
    tag: dns-out
route:
  rules:
    - inbound: 审计checker-in
      outbound: select
    - inbound: 审计checker_无审计-in
      outbound: 审计
    - clash_mode: Direct
      outbound: direct
    - type: logical
      mode: or
      rules:
        - port: 53
        - protocol: dns
      outbound: dns-out
    - clash_mode: Global
      outbound: select
    - ip_is_private: true
      outbound: direct
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: geosite-audit
      outbound: 审计
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: geosite-openai
          domain:
            - cdn.auth0.com
      outbound: OpenAI
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: Google
      outbound: Google
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - type: logical
          mode: or
          rules:
            - package_name: com.zhiliaoapp.musically
            - rule_set: geosite-tiktok
      outbound: TikTok
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: geosite-youtube
      outbound: YouTube
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: geosite-wikimedia
      outbound: Wikipedia
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set: geosite-bahamut
      outbound: 巴哈姆特
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - type: logical
          mode: and
          rules:
            - rule_set: geosite-amazon
            - domain_suffix:
                - cloudfront.net
              invert: true
      outbound: Amazon
    - type: logical
      mode: and
      rules:
        - network: udp
          invert: true
        - port: 22
          invert: true
        - rule_set:
            - geosite-geolocation-!cn
      outbound: select
    - type: logical
      mode: and
      rules:
        - rule_set:
            - geoip-cn
            - geosite-geolocation-cn
        - rule_set:
            - geosite-geolocation-!cn
          invert: true
      outbound: direct
    - type: logical
      mode: or
      rules:
        - network: udp
          port:
            - 443
            - 80
        - protocol: quic
      outbound: block
    - network: udp
      outbound: UDP
    - port: 22
      outbound: Port22SSH
    - clash_mode: Default
      outbound: select
    - process_name: #用以启用在ui中显示进程
        - placeholder
      outbound: select
  rule_set:
    - type: remote
      tag: geosite-geolocation-cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-cn.srs
      download_detour: select
    - type: remote
      tag: geosite-geolocation-!cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-geolocation-!cn.srs
      download_detour: select
    - type: remote
      tag: geoip-cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geoip/rule-set/geoip-cn.srs
      download_detour: select
    - type: remote
      tag: geosite-openai
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-openai.srs
      download_detour: select
    - type: remote
      tag: geosite-google
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google.srs
      download_detour: select
    - type: remote
      tag: geosite-google@cn
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-google@cn.srs
      download_detour: select
    - type: inline
      tag: Google
      rules:
        - domain:
            - www.google.com
            - google.com
    - type: remote
      tag: geosite-tiktok
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-tiktok.srs
      download_detour: select
    - type: remote
      tag: geosite-youtube
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-youtube.srs
      download_detour: select
    - type: remote
      tag: geosite-wikimedia
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-wikimedia.srs
      download_detour: select
    - type: remote
      tag: geosite-audit
      format: binary
      url: https://raw.githubusercontent.com/w311ang/my_singbox_template/main/geosite-audit.srs
      download_detour: select
    - type: remote
      tag: geosite-bahamut
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-bahamut.srs
      download_detour: select
    - type: remote
      tag: geosite-amazon
      format: binary
      url: https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-amazon.srs
      download_detour: select
  auto_detect_interface: true
experimental:
  cache_file:
    enabled: true
    store_rdrc: true
  clash_api:
    external_controller: 127.0.0.1:9090
    external_ui: dashboard
    default_mode: Default
